<!DOCTYPE html>
<html lang="en">
<style>
body {padding: 0; 
    margin: 0;
  overflow-x: hidden; 
  overflow-y: hidden;
}
#cover_sketch {padding: 0; 
    margin: 0;
}
#cover_overlay_wrap {padding: 0; 
    margin: 0;
    position: absolute;
    top: 0;
    left: 0;
}
#cover_overlay {padding: 0; 
    margin: 0;
    position: absolute;
    top: 0;
    left: 0;
    background: #000000;
    opacity: 0.2;
    width: 100%;
    height: 100%;
}
#cover_title {padding: 0; 
    margin: 0;
    position: absolute;
    top: 0;
    left: 0;
}
#cover_title_svg {padding: 0; 
    margin: 0;
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
}
#loading_text {
  margin: 0;
  top: 0;
  left: 0;
  height: 100vh;
  width: 100vw;
}
.cover-instruction {
  width: 100%;
  height: 60px;
  bottom: 10%;
  position: absolute;
  font-family: "Roboto","Helvetica Neue",Helvetica,Arial,sans-serif;
  font-size: 16px;
  font-weight: 300;
  color: #FFFFFF;
}
.scroll-down {
  width: 80px;
  height: 40px;
  right: 10px;
  bottom: 10px;
  position: absolute;
  font-family: "Roboto","Helvetica Neue",Helvetica,Arial,sans-serif;
  font-size: 12px;
  font-weight: 300;
  color: #FFFFFF;
  opacity: 0;
  -webkit-transition: opacity 2s ease-in;
  -moz-transition: opacity 2s ease-in;
  -o-transition: opacity 2s ease-in;
  -ms-transition: opacity 2s ease-in;
  transition: opacity 2s ease-in;
}
.scroll-down span {
  margin-top: 5px;
  position: absolute;
  left: 50%;
  transform: translate(-100%, 0) rotate(45deg);
  transform-origin: 100% 100%;
  height: 2px;
  width: 10px;
  background: #FFFFFF;
}
.scroll-down span:nth-of-type(2) {
  transform-origin: 0 100%;
  transform: translate(0, 0) rotate(-45deg);
}
.spinner {
  position: absolute;
  height: 160px;
  width: 160px;
  -webkit-animation: rotation .6s infinite linear;
  -moz-animation: rotation .6s infinite linear;
  -o-animation: rotation .6s infinite linear;
  animation: rotation .6s infinite linear;
  border-left: 6px solid rgba(0, 174, 239, .15);
  border-right: 6px solid rgba(0, 174, 239, .15);
  border-bottom: 6px solid rgba(0, 174, 239, .15);
  border-top: 6px solid rgba(0, 174, 239, .8);
  border-radius: 100%;
  top: calc(50% - 100px);
  left: calc(50% - 80px);
  right: auto;
  bottom: auto;
}

@-webkit-keyframes rotation {
  from {
    -webkit-transform: rotate(0deg);
  }
  to {
    -webkit-transform: rotate(359deg);
  }
}
.transparent {
  opacity: 0;
}

.figload {
  font-family: Helvetica,Arial,sans-serif;
  font-weight: 400;
  color: rgba(0, 174, 239, .8);
  font-size: 24px;
  line-height: 1.5em;
  display: block;
  width: 100%;
  text-align: center;
  position: absolute;
  top: calc(50% - 80px + 190px);
}

dt-article figcaption {
  padding: 0.5em;
  color: rgba(0, 0, 0, 0.6);
  font-size: 12px;
  line-height: 1.5em;
  text-align: left;
}

dt-article figcaption a {
  color: rgba(0, 0, 0, 0.6);
}

dt-article figcaption b {
  font-weight: 600;
  color: rgba(0, 0, 0, 1.0);
}

*.unselectable {
    -moz-user-select: -moz-none;
    -khtml-user-select: none;
    -webkit-user-select: none;
    -o-user-select: none;
    user-select: none;
}

*.svgunselectable {
    -moz-user-select: -moz-none;
    -khtml-user-select: none;
    -webkit-user-select: none;
    -o-user-select: none;
    user-select: none;
    background: none;
    pointer-events: none;
}
</style>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">

  <!-- roboto font -->
  <link href='https://fonts.googleapis.com/css?family=Roboto:300' rel='stylesheet' type='text/css'>
  <!-- icons -->
  <link rel="apple-touch-icon" sizes="57x57" href="logo/apple-icon-57x57.png">
  <link rel="apple-touch-icon" sizes="60x60" href="logo/apple-icon-60x60.png">
  <link rel="apple-touch-icon" sizes="72x72" href="logo/apple-icon-72x72.png">
  <link rel="apple-touch-icon" sizes="76x76" href="logo/apple-icon-76x76.png">
  <link rel="apple-touch-icon" sizes="114x114" href="logo/apple-icon-114x114.png">
  <link rel="apple-touch-icon" sizes="120x120" href="logo/apple-icon-120x120.png">
  <link rel="apple-touch-icon" sizes="144x144" href="logo/apple-icon-144x144.png">
  <link rel="apple-touch-icon" sizes="152x152" href="logo/apple-icon-152x152.png">
  <link rel="apple-touch-icon" sizes="180x180" href="logo/apple-icon-180x180.png">
  <link rel="icon" type="image/png" sizes="192x192"  href="logo/android-icon-192x192.png">
  <link rel="icon" type="image/png" sizes="32x32" href="logo/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="96x96" href="logo/favicon-96x96.png">
  <link rel="icon" type="image/png" sizes="16x16" href="logo/favicon-16x16.png">
  <link rel="manifest" href="logo/manifest.json">
  <meta name="msapplication-TileColor" content="#ffffff">
  <meta name="msapplication-TileImage" content="logo/ms-icon-144x144.png">
  <meta name="theme-color" content="#ffffff">
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-116311758-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-116311758-1');
  </script>
  <!-- SEO -->
  <meta property="og:title" content="World Models" />
  <meta property="og:type" content="article" />
  <meta property="og:description" content="Can agents learn inside of their own dreams?" />
  <meta property="og:image" content="https://worldmodels.github.io/assets/world_models_card_both.png" />
  <meta property="og:url" content="https://worldmodels.github.io/doomrnn.html" />
  <!-- Twitter Card data -->
  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="World Models" />
  <meta name="twitter:description" content="Can agents learn inside of their own dreams?" />
  <meta property="og:site_name" content="World Models" />
  <meta name="twitter:image" content="https://worldmodels.github.io/assets/world_models_card_single.png" />

  </head>

  <title>DoomRNN Demo</title>

  <script src="https://storage.googleapis.com/quickdraw-models/sketchRNN/world_models/demo/lib/jquery-1.12.4.min.js"></script>
  <script src="https://storage.googleapis.com/quickdraw-models/sketchRNN/world_models/demo/lib/mobile-detect.min.js"></script>

</head>
</body>
<div id="loading_text">
<div class="spinner"></div>
<div class="figload">&nbsp;&nbsp;&nbsp;&nbsp;Loading DoomRNN ...</div>
</div>
<div id="cover_overlay_wrap" class="unselectable">
  <div id="cover_overlay" class="unselectable">
  </div>
  <div id="cover_instruction" class="cover-instruction" style="text-align: center;">
    <div id="cover_instruction_text">Interactive demo: Tap screen to override the agent's decisions.</div>
  </div>
</div>
<div id="cover_title" class="unselectable">
  <img src="../assets/cover_title.svg" id="cover_title_svg" class="svgunselectable"/>
</div>
<div id="doomrnn_sketch" class="unselectable"></div>
</body>
<script>
// controller
var scroll_top = 0;
var scroll_bottom = 1;
$(document).scroll(function(){
  scroll_top = $(document).scrollTop();
  scroll_bottom = scroll_top + $(document).height();
});

var contKeyMap = {};

$(document).keydown(function(e) {
  e = e || event; // to deal with IE
  contKeyMap[e.keyCode] = e.type == 'keydown';
});

$(document).keyup(function(e) {
  e = e || event; // to deal with IE
  contKeyMap[e.keyCode] = e.type == 'keydown';
});

// mobile detection
var md = new MobileDetect(window.navigator.userAgent);
var mobileMode = false;
if (md.mobile()) {
  mobileMode = true;
}
if (!mobileMode) {
  console.log('desktop mode');
} else {
  console.log('mobile mode');
}

// resize cover
function resize_cover() {
  "use strict";

  var screen_x = Math.max(window.innerWidth, 320);
  var screen_y = Math.max(window.innerHeight, 320);

  if (screen_y > screen_x) { // vertical
    //console.log("vertical mode screen_x = "+screen_x+", screen_y = "+screen_y);

    $('#cover_overlay_wrap').width(screen_x+'px');
    $('#cover_overlay_wrap').height(screen_x+'px');

    $('#cover_title').width(screen_x+'px');
    $('#cover_title').height(screen_x+'px');

  } else { // horizontal
    //console.log("horizontal mode screen_x = "+screen_x+", screen_y = "+screen_y);

    $('#cover_overlay_wrap').width(screen_x+'px');
    $('#cover_overlay_wrap').height(screen_y+'px');

    $('#cover_title').width(screen_y+'px');
    $('#cover_title').height(screen_y+'px');

  }

}

// fade in the instructions
function show_instructions() {
  "use strict";
  var instruction_mobile = "Interactive demo → Tap screen to override the agent's decisions.";
  var instruction_desktop = "Interactive demo → Tap screen or use arrow keys to override the agent's decisions.";
  var instruction;
  if (mobileMode) {
    instruction = instruction_mobile;
  } else {
    instruction = instruction_desktop;
  }
  var screen_x = Math.max(window.innerWidth, 320);
  var screen_y = Math.max(window.innerHeight, 320);
  $('#cover_instruction_text').text(instruction);
  $('#cover_instruction').delay(20000).fadeOut("slow");
  $('#cover_overlay_wrap').delay(15000).fadeOut("slow");
  $('#cover_title').delay(15000).fadeOut("slow");
}

$( window ).resize(function() {
  resize_cover();
});

var WorldController = {};
(function(global) {
  "use strict";

  var frameRendered = false;
  function checkFirstFrameRendered() {
    if (frameRendered === false) {
      // only do this once.
      frameRendered = true;
      console.log("Displaying document now.");

      $("#loading_text").hide();

      resize_cover();
      show_instructions();
    }
  }
  global.checkFirstFrameRendered = checkFirstFrameRendered;
  console.log("Controller Initialized.");
})(WorldController);
(function(lib) {
  "use strict";
  if (typeof module === "undefined" || typeof module.exports === "undefined") {
    //window.jsfeat = lib; // in ordinary browser attach library to window
  } else {
    module.exports = lib; // in nodejs
  }
})(WorldController);
</script>
<script src="https://storage.googleapis.com/quickdraw-models/sketchRNN/world_models/demo/lib/p5.custom.js"></script>
<script src="https://storage.googleapis.com/quickdraw-models/sketchRNN/world_models/demo/lib/p5.dom.min.js"></script>
<script src="https://storage.googleapis.com/quickdraw-models/sketchRNN/world_models/demo/lib/deeplearn.0.3.10.js"></script>
<script src="https://storage.googleapis.com/quickdraw-models/sketchRNN/world_models/demo/lib/b64tool.js"></script>
<script src="https://storage.googleapis.com/quickdraw-models/sketchRNN/world_models/demo/models/doomrnn.min.js"></script>
<script src="https://storage.googleapis.com/quickdraw-models/sketchRNN/world_models/demo/models/doomvae.min.js"></script>
<script>
// doom model
var DoomRNN = {};

(function(global) {
  "use strict";

  var z_size = 64;
  var rnn_size = 512;
  var num_mixture = 5;

  function dequantize(x, factor) {
    for (var i=x.length-1;i>=0;i--) {
      x[i] /= factor;
    }
    return x;
  }

  var init_mu=[-6660,80,-3723,-649,-983,1237,287,7158,283,-7310,1152,836,-215,6484,231,-890,-378,40,-1322,-506,-305,-126,-20391,-182,-8535,-9346,459,-3652,92,425,5,356,447,-6772,315,531,3760,720,-332,-156,-706,259,-1179,-424,37,1335,-496,-19,472,-557,5757,-775,-12656,-69,1144,2294,524,1334,-1213,5669,-230,116,415,-50];
  var init_logvar=[-44258,-147,-34746,-93,-57852,-186,-260,-20469,-299,-43516,-218,-500,-207,-41133,-332,-51445,-210,-244,-1807,-392,-257,-93,-61484,-250,-44258,-52500,-92,-42031,-58,-140,-103,-68,-346,-40273,-228,-451,-6592,-192,-219,-458,-166,-244,-732,30,-30,-514,-550,-180,-327,-314,-10615,-10879,-45586,-354,-23145,-23848,-245,-658,-420,-45703,-248,-129,-230,34];

  // Random numbers util (from https://github.com/karpathy/recurrentjs)
  var return_v = false;
  var v_val = 0.0;
  function gaussRandom() {
    if(return_v) {
      return_v = false;
      return v_val;
    }
    var u = 2*Math.random()-1;
    var v = 2*Math.random()-1;
    var r = u*u + v*v;
    if(r == 0 || r > 1) return gaussRandom();
    var c = Math.sqrt(-2*Math.log(r)/r);
    v_val = v*c; // cache this
    return_v = true;
    return u*c;
  }
  function randf(a, b) { return Math.random()*(b-a)+a; };
  function randi(a, b) { return Math.floor(Math.random()*(b-a)+a); };
  function randn(mu, std){ return mu+gaussRandom()*std; };
  // from http://www.math.grin.edu/~mooret/courses/math336/bivariate-normal.html
  function birandn(mu1, mu2, std1, std2, rho) {
    var z1 = randn(0, 1);
    var z2 = randn(0, 1);
    var x = Math.sqrt(1-rho*rho)*std1*z1 + rho*std1*z2 + mu1;
    var y = std2*z2 + mu2;
    return [x, y];
  };

  function tanh(z) {
    var y = new Array(z.length);
    for (var i=0;i<z.length;i++) {
      y[i] = Math.tanh(z[i]);
    }
    return y;
  };

  function exp(z) {
    var y = new Array(z.length);
    for (var i=0;i<z.length;i++) {
      y[i] = Math.exp(z[i]);
    }
    return y;
  };

  function sum(z) {
    var y = 0;
    for (var i=0;i<z.length;i++) {
      y += z[i];
    }
    return y;
  };

  function elem_mul(y, z) {
    // element-wise mult
    var x = new Array(z.length);
    for (var i=0;i<z.length;i++) {
      x[i] = y[i] * z[i];
    }
    return x;
  };

  function elem_add(y, z) {
    // vector add
    var x = new Array(z.length);
    for (var i=0;i<z.length;i++) {
      x[i] = y[i] + z[i];
    }
    return x;
  };

  function random_normal_vector() {
    // the same as random_latent_vector. in the future, random_latent_vector may be non-gaussian.
    var z = new Array(z_size);
    for (var i=0;i<z_size;i++) {
      z[i] = gaussRandom();
    }
    return z;
  };

  function init_rnn_state() {
    // the same as random_latent_vector. in the future, random_latent_vector may be non-gaussian.
    var s = new Array(rnn_size);
    for (var i=0;i<rnn_size;i++) {
      s[i] = 0;
    }
    return s;
  };

  function getVAEModelParams(data) {

    var factor = 10000;

    dec_fc_kernel = dl.Array2D.new([z_size, 1024], dequantize(data[0], factor));
    dec_fc_bias = dl.Array1D.new(dequantize(data[1], factor));
    dec_deconv1_kernel = dl.Array4D.new([5, 5, 128, 1024], dequantize(data[2], factor));
    dec_deconv1_bias = dl.Array1D.new(dequantize(data[3], factor));
    dec_deconv2_kernel = dl.Array4D.new([5, 5, 64, 128], dequantize(data[4], factor));
    dec_deconv2_bias = dl.Array1D.new(dequantize(data[5], factor));
    dec_deconv3_kernel = dl.Array4D.new([6, 6, 32, 64], dequantize(data[6], factor));
    dec_deconv3_bias = dl.Array1D.new(dequantize(data[7], factor));
    dec_deconv4_kernel = dl.Array4D.new([6, 6, 3, 32], dequantize(data[8], factor));
    dec_deconv4_bias = dl.Array1D.new(dequantize(data[9], factor));

  }

  function getRNNModelParams(data) {

    var factor = 10000;

    lstm_kernel = dl.Array2D.new([578, 2048], dequantize(data[0], factor));
    lstm_bias = dl.Array1D.new(dequantize(data[1], factor));
    output_w = dl.Array2D.new([512, 961], dequantize(data[2], factor));
    output_b = dl.Array1D.new(dequantize(data[3], factor));

    lstm_forget_bias = dl.Scalar.new(1.0);

  }

  function vae_decode(z_array) {
    var out = math.scope(function(keep, track) { // keep and track are two methods to help with memory management
      // Because you are constructing an array directly,
      // our automatic memory manager doesn't know about it. You should "track" it.
      // Later versions will fix this problem and do this automatically, we're working on it
      var dec_z;
      if (z_array) {
        dec_z = track(dl.Array1D.new(z_array));
      } else {
        dec_z = track(dl.Array1D.randNormal([z_size]));
      }
      var h = math.add(math.matMul(dec_z.reshape([1, z_size]), dec_fc_kernel), dec_fc_bias);
      h = h.reshape([1, 1, 4*256]);
      h = math.relu(math.add(math.conv2dTranspose(h, dec_deconv1_kernel, [5, 5, 128], 2, "valid"), dec_deconv1_bias));
      h = math.relu(math.add(math.conv2dTranspose(h, dec_deconv2_kernel, [13, 13, 64], 2, "valid"), dec_deconv2_bias));
      h = math.relu(math.add(math.conv2dTranspose(h, dec_deconv3_kernel, [30, 30, 32], 2, "valid"), dec_deconv3_bias));
      h = math.sigmoid(math.add(math.conv2dTranspose(h, dec_deconv4_kernel, [64, 64, 3], 2, "valid"), dec_deconv4_bias));
      return h;
    })
    return out.dataSync();
  }

  // sample from a categorial distribution
  function sample_softmax(z_sample) {
    var x = randf(0, 1);
    var N = z_sample.length;
    var accumulate = 0;
    var i;
    for (i=0;i<N;i++) {
      accumulate += z_sample[i];
      if (accumulate >= x) {
        return i;
      }
    }
    console.log('error sampling pi index');
    return -1;
  };

  function rnn_forward(z, action, restart, c, h, temp) {
    var temperature = 1.0;
    if (temp && temp > 0) {
      temperature = temp;
    }
    var out = math.scope(function(keep, track) { // keep and track are two methods to help with memory management
      // Because you are constructing an array directly,
      // our automatic memory manager doesn't know about it. You should "track" it.
      // Later versions will fix this problem and do this automatically, we're working on it
      var rnn_input = track(dl.Array1D.new(z.concat([action, restart])));
      var rnn_c = track(dl.Array1D.new(c));
      var rnn_h = track(dl.Array1D.new(h));
      var rnn_temp = track(dl.Scalar.new(temperature));
      var rnn_temp_sqrt = track(dl.Scalar.new(Math.sqrt(temperature)));
      var epsilon = track(dl.Array2D.randNormal([z_size, num_mixture]));

      rnn_input = rnn_input.reshape([1, z_size+2]);
      rnn_c = rnn_c.reshape([1, rnn_size]);
      rnn_h = rnn_h.reshape([1, rnn_size]);

      var next_state = math.basicLSTMCell(lstm_forget_bias, lstm_kernel, lstm_bias, rnn_input, rnn_c, rnn_h);

      var output = math.add(math.matMul(next_state[1], output_w), output_b);

      var logrestart = math.slice2D(output, [0, 0], [1, 1]);

      output = math.slice2D(output, [0, 1], [1, z_size*num_mixture*3]);
      output = output.reshape([-1, num_mixture*3])

      var logmix = math.slice2D(output, [0, 0], [z_size, num_mixture]);
      var logmix_subtract = math.logSumExp(logmix, 1, true);
      logmix = math.subtract(logmix, logmix_subtract);
      logmix = math.arrayDividedByScalar(logmix, rnn_temp)

      var mu = math.slice2D(output, [0, num_mixture], [z_size, num_mixture]);

      var logstd = math.slice2D(output, [0, 2*num_mixture], [z_size, num_mixture]);
      var std = math.exp(logstd);
      std = math.scalarTimesArray(rnn_temp_sqrt, std);

      logmix = logmix.reshape([-1, num_mixture]);
      mu = mu.reshape([-1, num_mixture]);
      std = std.reshape([-1, num_mixture]);

      var p = math.softmax(logmix); // categorical distribution
      var idx = math.multinomial(p, 1); // sampled the index from logmix (seems smoother performance if we can use this).

      var zs = math.add(mu, math.multiply(std, epsilon)) // 5 possible z's

      var next_c = next_state[0].reshape([-1]);
      var next_h = next_state[1].reshape([-1]);
      var next_logrestart = logrestart.reshape([-1]);
      var next_idx = idx.reshape([-1]);
      var next_p = p.reshape([-1]);
      var next_zs = zs.reshape([-1]);
      var result = math.concat1D(math.concat1D(math.concat1D(next_c, next_h), next_logrestart),  math.concat1D(next_p, next_zs));
      //var result = math.concat1D(math.concat1D(math.concat1D(next_c, next_h), math.concat1D(next_logrestart, next_idx)),  next_zs);
      return result;
    })
    var next_c, next_h, logrestart, zs, k;
    var next_z = new Array(z_size);

    var result = out.dataSync();
    var pos_start = 0;
    var pos_end = rnn_size;
    var next_c = result.slice(pos_start, pos_end);
    pos_start = pos_end;
    pos_end += rnn_size;
    var next_h = result.slice(pos_start, pos_end);
    pos_start = pos_end;
    pos_end += 1;
    var next_logrestart = result.slice(pos_start, pos_end);
    /*
    pos_start = pos_end;
    pos_end += z_size;
    var next_idx = result.slice(pos_start, pos_end);
    */
    pos_start = pos_end;
    pos_end += z_size*num_mixture;
    var next_p = result.slice(pos_start, pos_end);
    
    pos_start = pos_end;
    pos_end += z_size*num_mixture;
    var zs = result.slice(pos_start, pos_end);

    var idx = -1;
    var sub_p;

    function normalize(x) {
      var sum = 0;
      var i;
      var N = x.length;
      var y = new Array(N);
      for (i=0; i<N; i++) {
        sum += x[i];
      }
      for (i=0; i<N; i++) {
        y[i] = x[i] / sum;
      }
      return y;
    }

    // var max_z = -100000, min_z = 100000;
    for (var i=0;i<z_size;i++) {

      //idx = next_idx[i];

      /* Mac needs this: */
      sub_p = next_p.slice(num_mixture*i, num_mixture*(i+1));
      idx = sample_softmax(normalize(sub_p));
      if (idx < 0) {// sampling error (due to bad precision in gpu mode)
        idx = randi(0, num_mixture);
      }
      // end Mac.

      k = num_mixture*i+idx;
      next_z[i] = zs[k]; // + std[k] * epsilon[i];
      /*
      if (z[i] > max_z) {
        max_z = z[i];
      }
      if (z[i] < min_z) {
        min_z = z[i];
      }
      */
    }

    return [next_z, next_c, next_h, next_logrestart];
  }

  function init_random_z() {
    //return init_mu;
    return elem_add(init_mu, elem_mul(init_std, random_normal_vector()));
  }

  function process_b64data(data, factor) {
    var result = [];
    for (var i=0;i<data.length;i++) {
      var blob = new Float32Array(string_to_array(data[i]));
      for (var j=0;j<blob.length;j++) {
        blob[j] *= factor;
      }
      result.push(blob);
    }
    return result;
  }

  doomvae_data = process_b64data(doomvae_data, 1);
  doomrnn_data = process_b64data(doomrnn_data, 20/3);
  //var doomvae_data = JSON.parse(vae_data);
  //var doomrnn_data = JSON.parse(rnn_data);

  // define model:
  var dec_fc_kernel;
  var dec_fc_bias;
  var dec_deconv1_kernel;
  var dec_deconv1_bias;
  var dec_deconv2_kernel;
  var dec_deconv2_bias;
  var dec_deconv3_kernel;
  var dec_deconv3_bias;
  var dec_deconv4_kernel;
  var dec_deconv4_bias;
  var lstm_kernel;
  var lstm_bias;
  var output_w;
  var output_b;
  var lstm_forget_bias;

  var math = new dl.NDArrayMathGPU();

  // setup init mu, std
  init_mu = dequantize(init_mu, 10000);
  var init_std = exp(dequantize(init_logvar, 20000));

  // read params into gpu
  getVAEModelParams(doomvae_data);
  getRNNModelParams(doomrnn_data);

  function get_action(z, c, h, agent_brain) {
    var s = new Float32Array(z_size+2*rnn_size);
    s.set(z);
    s.set(c, z_size);
    s.set(h, z_size+rnn_size);
    return Math.tanh(sum(elem_mul(s, agent_brain)));
  }

  global.z_size = z_size;
  global.rnn_size = rnn_size;
  global.random_normal_vector = random_normal_vector;
  global.init_rnn_state = init_rnn_state;
  global.init_random_z = init_random_z;
  global.rnn_forward = rnn_forward;
  global.vae_decode = vae_decode;
  global.dequantize = dequantize;
  global.get_action = get_action;
  global.randn = randn;
  global.randi = randi;
  global.randf = randf;
  global.math = math;

  console.log("DoomRNN Initialized.");

})(DoomRNN);
(function(lib) {
  "use strict";
  if (typeof module === "undefined" || typeof module.exports === "undefined") {
    //window.jsfeat = lib; // in ordinary browser attach library to window
  } else {
    module.exports = lib; // in nodejs
  }
})(DoomRNN);
</script>
<script src="../demo/doomrnn_demo.js"></script>
<script>

var doombrain = doombrain_t115;

if (DoomRNN.randi(0, 2) == 0) {
  doombrain = doombrain_r130;
}

var doomrnn_settings = {
  div_name: 'doomrnn_sketch',
  temperature: DoomRNN.randf(0.9, 2.2),
  agent_brain: doombrain,
  slider_mode: true,
  square_mode: false,
  cover_mode: false,
};

var custom_p5 = new p5(doommrnn_demo(doomrnn_settings), doomrnn_settings.div_name);

</script>
</html>
